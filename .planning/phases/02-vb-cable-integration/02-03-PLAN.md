---
phase: 02-vb-cable-integration
plan: 03
type: execute
---

<objective>
Add auto-configuration, device retry logic, and finalize VB-Cable integration.

Purpose: Complete the user experience - auto-select VB-Cable as broadcast device, handle timing issues.
Output: Polished VB-Cable integration with automatic configuration after installation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vb-cable-integration/02-RESEARCH.md
@.planning/phases/02-vb-cable-integration/02-CONTEXT.md
@.planning/phases/02-vb-cable-integration/02-01-SUMMARY.md
@.planning/phases/02-vb-cable-integration/02-02-SUMMARY.md

**Relevant source files:**
@src/components/settings/VbCableSettings.tsx
@src/components/settings/AudioDeviceSettings.tsx
@src/contexts/SettingsContext.tsx
@src-tauri/src/vbcable/detection.rs
@src-tauri/src/commands/vbcable.rs
@src-tauri/src/settings.rs

**User vision from CONTEXT.md:**
- Nach Install: VB-Cable automatisch als Secondary Output wählen
- Nahtlose Installation - trotz Windows-Einschränkungen mühelos

**Research findings - Pitfall to address:**
- Device enumeration timing: VB-Cable may not be detected immediately after install
- Need retry logic with delay
- May need reboot in some cases

**Note:** Feature branch `feature/vb-cable-integration` was created in Plan 01.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device detection retry logic</name>
  <files>src-tauri/src/vbcable/detection.rs, src-tauri/src/commands/vbcable.rs</files>
  <action>
**detection.rs** - Add retry function:
```rust
use std::thread;
use std::time::Duration;

const MAX_RETRIES: u32 = 5;
const RETRY_DELAY_MS: u64 = 1000;

/// Wait for VB-Cable to appear in device list (with retries)
/// Use after installation when Windows needs time to register the device
pub fn wait_for_vb_cable() -> Option<VbCableInfo> {
    for attempt in 0..MAX_RETRIES {
        if let Some(info) = detect_vb_cable() {
            tracing::info!("VB-Cable detected on attempt {}", attempt + 1);
            return Some(info);
        }

        if attempt < MAX_RETRIES - 1 {
            tracing::debug!("VB-Cable not found, retrying in {}ms...", RETRY_DELAY_MS);
            thread::sleep(Duration::from_millis(RETRY_DELAY_MS));
        }
    }

    tracing::warn!("VB-Cable not detected after {} attempts", MAX_RETRIES);
    None
}
```

Export in mod.rs:
```rust
pub use detection::{detect_vb_cable, is_vb_cable_installed, wait_for_vb_cable, VbCableInfo, VbCableStatus};
```

**commands/vbcable.rs** - Add wait command:
```rust
/// Wait for VB-Cable to appear after installation (with retries)
#[tauri::command]
pub fn wait_for_vb_cable_device() -> Option<String> {
    wait_for_vb_cable().map(|info| info.output_device)
}
```

Register in lib.rs invoke_handler.
  </action>
  <verify>cargo check compiles, new command registered</verify>
  <done>Retry logic added and command registered</done>
</task>

<task type="auto">
  <name>Task 2: Implement auto-configuration after installation</name>
  <files>src/components/settings/VbCableSettings.tsx, src/contexts/SettingsContext.tsx</files>
  <action>
**VbCableSettings.tsx** - Update handleInstall to auto-configure:
After successful installation and detection, automatically set VB-Cable as broadcast device:

```tsx
const handleInstall = async () => {
  setIsInstalling(true);
  setError(null);

  try {
    // Save current default device before install
    const deviceId = await invoke<string>("save_default_audio_device");
    setSavedDeviceId(deviceId);

    // Start installation
    await invoke("start_vb_cable_install");

    // Wait for VB-Cable to appear (with retries)
    const vbCableDeviceName = await invoke<string | null>("wait_for_vb_cable_device");

    if (!vbCableDeviceName) {
      setError("VB-Cable installation complete, but device not detected. You may need to restart your computer.");
      return;
    }

    // Update status
    await checkStatus();

    // Restore default audio device
    if (deviceId) {
      await invoke("restore_default_audio_device", { deviceId });
    }

    // Auto-configure: Set VB-Cable as broadcast device
    // Need to find the device ID from the device list
    const devices = await invoke<AudioDevice[]>("list_audio_devices");
    const vbCableDevice = devices.find(d =>
      d.name.toLowerCase().includes("cable input")
    );

    if (vbCableDevice && onAutoConfigureBroadcast) {
      onAutoConfigureBroadcast(vbCableDevice.id);
    }

    // Notify parent to refresh device list
    onDeviceChange?.();

    // Cleanup temp files
    await invoke("cleanup_vb_cable_install");

    setInstallSuccess(true);
  } catch (e) {
    setError(`Installation failed: ${e}`);
  } finally {
    setIsInstalling(false);
  }
};
```

Add props and state:
```tsx
interface VbCableSettingsProps {
  onDeviceChange?: () => void;
  onAutoConfigureBroadcast?: (deviceId: string) => void;
}

const [installSuccess, setInstallSuccess] = useState(false);
```

Add success message in UI:
```tsx
{installSuccess && (
  <div className="flex items-center gap-2 text-discord-success">
    <span className="text-lg">✓</span>
    <span>VB-Cable installed and configured as Broadcast Output</span>
  </div>
)}
```

**Settings.tsx** - Pass auto-configure callback:
```tsx
<VbCableSettings
  onDeviceChange={handleRefresh}
  onAutoConfigureBroadcast={(deviceId) => {
    updateSetting("broadcast_device_id", deviceId);
  }}
/>
```

Import AudioDevice type if needed.
  </action>
  <verify>yarn typecheck passes, yarn tauri dev shows auto-configuration working</verify>
  <done>Auto-configuration implemented, VB-Cable automatically set as broadcast device after install</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete VB-Cable integration with auto-configuration</what-built>
  <how-to-verify>
    1. Ensure you're on feature/vb-cable-integration branch
    2. Run: yarn tauri dev
    3. Open Settings
    4. If VB-Cable is NOT installed:
       - Click "Install VB-Cable"
       - Approve Windows driver dialog
       - After installation:
         - VB-Cable should be detected
         - Broadcast Output should auto-select VB-Cable
         - Success message should appear
    5. If VB-Cable IS already installed:
       - Status shows installed
       - You can manually select VB-Cable in Broadcast Output dropdown
    6. Verify audio routing:
       - Play a sound
       - Should hear on Monitor Output (your speakers/headphones)
       - Should route to Broadcast Output (VB-Cable → Discord)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] On feature/vb-cable-integration branch (created in Plan 01)
- [ ] `cargo check --manifest-path src-tauri/Cargo.toml` succeeds
- [ ] `cargo test --manifest-path src-tauri/Cargo.toml` passes
- [ ] `yarn typecheck` passes
- [ ] `yarn lint` passes
- [ ] VB-Cable auto-configuration works
- [ ] Retry logic handles timing issues
- [ ] Human verified end-to-end flow
</verification>

<success_criteria>
- All tasks completed
- Feature branch contains all VB-Cable work (Plans 01, 02, 03)
- VB-Cable auto-selected as broadcast device after installation
- Detection retry handles Windows timing issues
- Human verified complete flow works
- Ready to commit and create PR to develop
</success_criteria>

<output>
After completion, create `.planning/phases/02-vb-cable-integration/02-03-SUMMARY.md`

Then:
1. Commit all changes with: `git add . && git commit -m "feat: VB-Cable integration with auto-detection and installation"`
2. Push branch: `git push -u origin feature/vb-cable-integration`
3. Create PR to develop with summary of changes
</output>

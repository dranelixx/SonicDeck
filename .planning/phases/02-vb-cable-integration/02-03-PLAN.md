---
phase: 02-vb-cable-integration
plan: 03
type: execute
---

<objective>
Add VB-Cable donationware notice (license requirement) and smart device detection retry logic.

Purpose: Comply with VB-Cable distribution license and improve installation reliability.
Output: Donationware hint in UI, intelligent retry logic that actively checks for device availability.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-vb-cable-integration/02-RESEARCH.md
@.planning/phases/02-vb-cable-integration/02-CONTEXT.md
@.planning/phases/02-vb-cable-integration/02-01-SUMMARY.md
@.planning/phases/02-vb-cable-integration/02-02-SUMMARY.md

**Relevant source files:**
@src/components/settings/VbCableSettings.tsx
@src-tauri/src/vbcable/detection.rs
@src-tauri/src/vbcable/mod.rs
@src-tauri/src/commands/vbcable.rs
@src-tauri/src/lib.rs

**VB-Cable License Requirements (CRITICAL):**
From vb-audio.com - Distribution with other products requires:
1. Show origin: www.vb-cable.com
2. State that VB-Cable is donationware
3. User must be able to donate/pay if finding it useful

**Current state (after 02-02):**
- VB-Cable installation works ✓
- All 4 default devices saved/restored ✓
- Auto-select VB-Cable as broadcast device ✓
- Uses static 3s delay instead of smart retry logic ✗
- No donationware notice in UI (license violation!) ✗
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add donationware notice to VbCableSettings UI</name>
  <files>src/components/settings/VbCableSettings.tsx</files>
  <action>
Add a donationware notice that appears when VB-Cable is installed.
Must include:
- Origin: vb-audio.com / vb-cable.com
- Donationware statement
- Link to VB-Audio website for donations

Add below the "VB-Cable ist installiert" status message:
```tsx
{status?.status === "installed" && (
  <div className="mt-3 p-3 bg-discord-darker rounded text-sm text-discord-text-muted">
    <p>
      VB-Cable ist Donationware von{" "}
      <button
        onClick={handleOpenWebsite}
        className="text-discord-primary hover:underline"
      >
        vb-audio.com
      </button>
    </p>
    <p className="mt-1">
      Wenn du es nützlich findest, unterstütze die Entwickler mit einer Spende!
    </p>
  </div>
)}
```

The `handleOpenWebsite` function already exists and opens vb-audio.com.
  </action>
  <verify>yarn typecheck passes, donationware notice visible in Settings when VB-Cable installed</verify>
  <done>Donationware notice added, VB-Cable license requirements fulfilled</done>
</task>

<task type="auto">
  <name>Task 2: Add smart retry logic for device detection</name>
  <files>src-tauri/src/vbcable/detection.rs, src-tauri/src/vbcable/mod.rs, src-tauri/src/commands/vbcable.rs, src-tauri/src/lib.rs</files>
  <action>
**detection.rs** - Add retry function:
```rust
use std::thread;
use std::time::Duration;

const MAX_RETRIES: u32 = 5;
const RETRY_DELAY_MS: u64 = 1000;

/// Wait for VB-Cable to appear in device list (with active retries)
/// Use after installation when Windows needs time to register the device.
/// Returns early as soon as device is detected, or None after all retries.
pub fn wait_for_vb_cable() -> Option<VbCableInfo> {
    for attempt in 1..=MAX_RETRIES {
        if let Some(info) = detect_vb_cable() {
            tracing::info!("VB-Cable detected on attempt {}/{}", attempt, MAX_RETRIES);
            return Some(info);
        }

        if attempt < MAX_RETRIES {
            tracing::debug!("VB-Cable not found (attempt {}/{}), retrying in {}ms...",
                attempt, MAX_RETRIES, RETRY_DELAY_MS);
            thread::sleep(Duration::from_millis(RETRY_DELAY_MS));
        }
    }

    tracing::warn!("VB-Cable not detected after {} attempts", MAX_RETRIES);
    None
}
```

**mod.rs** - Export new function:
```rust
pub use detection::{detect_vb_cable, wait_for_vb_cable, VbCableInfo, VbCableStatus};
```

**commands/vbcable.rs** - Add Tauri command:
```rust
use crate::vbcable::wait_for_vb_cable;

/// Wait for VB-Cable device to appear after installation (with smart retries)
/// Returns the device name if found, None if not detected after retries.
#[tauri::command]
pub fn wait_for_vb_cable_device() -> Option<String> {
    info!("Waiting for VB-Cable device with retry logic...");
    wait_for_vb_cable().map(|info| info.output_device)
}
```

**lib.rs** - Register command in invoke_handler:
Add `commands::wait_for_vb_cable_device` to the handler list.
  </action>
  <verify>cargo check compiles, new command registered</verify>
  <done>Smart retry logic added with active device checking</done>
</task>

<task type="auto">
  <name>Task 3: Use smart retry in frontend installation flow</name>
  <files>src/components/settings/VbCableSettings.tsx</files>
  <action>
Replace the static 3s delay with the smart retry command:

**Before (static delay):**
```typescript
// Step 3: Wait for Windows to register the new device
setInstallStep("Warte auf Geräte-Registrierung...");
await new Promise((resolve) => setTimeout(resolve, 3000));
```

**After (smart retry):**
```typescript
// Step 3: Wait for VB-Cable device with smart retry
setInstallStep("Warte auf VB-Cable Gerät...");
const detectedDevice = await invoke<string | null>("wait_for_vb_cable_device");

if (!detectedDevice) {
  console.warn("VB-Cable not detected after retries, continuing anyway...");
}
```

Benefits:
- Returns early if device found (faster on most systems)
- Tries up to 5 times with 1s delays (more robust for slow systems)
- Logs progress for debugging
  </action>
  <verify>yarn typecheck passes, installation uses smart retry</verify>
  <done>Frontend uses smart retry logic instead of static delay</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Donationware notice and smart retry logic</what-built>
  <how-to-verify>
    1. Run: yarn tauri dev
    2. Open Settings
    3. If VB-Cable is installed:
       - Donationware notice should appear below status
       - Link to vb-audio.com should work
    4. If VB-Cable is NOT installed:
       - Install VB-Cable
       - Watch logs for retry attempts ("VB-Cable detected on attempt X/5")
       - Should complete faster than before if device registers quickly
    5. Verify donationware notice appears after installation
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check --manifest-path src-tauri/Cargo.toml` succeeds
- [ ] `yarn typecheck` passes
- [ ] `yarn lint` passes
- [ ] Donationware notice visible when VB-Cable installed
- [ ] Smart retry logic working (check logs)
- [ ] Human verified both features
</verification>

<success_criteria>
- VB-Cable license requirements fulfilled (donationware notice)
- Smart retry logic replaces static delay
- Installation flow more reliable and potentially faster
</success_criteria>

<output>
After completion, create `.planning/phases/02-vb-cable-integration/02-03-SUMMARY.md`
</output>
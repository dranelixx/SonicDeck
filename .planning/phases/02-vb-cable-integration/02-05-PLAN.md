---
phase: 02-vb-cable-integration
plan: 05
type: execute
---

<objective>
Disable the unused "CABLE In 16 Ch" audio device that VB-Cable Pack45 installs.

Purpose: Clean up unnecessary audio devices to reduce user confusion.
Output: Automatic disabling of "CABLE In 16 Ch" after VB-Cable installation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-vb-cable-integration/02-RESEARCH.md
@.planning/phases/02-vb-cable-integration/02-CONTEXT.md
@.planning/phases/02-vb-cable-integration/02-01-SUMMARY.md
@.planning/phases/02-vb-cable-integration/02-02-SUMMARY.md
@.planning/phases/02-vb-cable-integration/02-03-SUMMARY.md
@.planning/phases/02-vb-cable-integration/02-04-SUMMARY.md

**Relevant source files:**
@src/components/settings/VbCableSettings.tsx
@src-tauri/src/vbcable/mod.rs
@src-tauri/src/commands/vbcable.rs

**The Problem:**
VB-Cable Pack45 installs an additional device "CABLE In 16 Ch" under playback devices.
SonicDeck only needs:
- CABLE Input (Wiedergabe) - for sending sounds
- CABLE Output (Aufnahme) - for Discord to receive

"CABLE In 16 Ch" is not needed and clutters the device list.

**Technical approach:**
Disabling audio devices in Windows requires:
- SetupAPI (SetupDiSetClassInstallParams with DIF_PROPERTYCHANGE)
- Administrator rights
- Device Instance ID

This is similar to what Device Manager does when you right-click → Disable.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Research Windows device disable API</name>
  <files>None (research only)</files>
  <action>
Research how to programmatically disable audio devices in Windows:

1. **SetupAPI approach**:
   - SetupDiGetClassDevs to enumerate devices
   - SetupDiSetClassInstallParams with DIF_PROPERTYCHANGE
   - DICS_DISABLE to disable device

2. **PowerShell approach** (fallback):
   - Disable-PnpDevice cmdlet
   - Requires admin rights

3. **Registry approach** (not recommended):
   - Direct registry manipulation is fragile

Key questions:
- Do we need admin rights? (Probably yes)
- Can we do this silently or need UAC prompt?
- How do we identify the correct device?
- Should we re-enable on uninstall?
  </action>
  <verify>Research documented, approach decided</verify>
  <done>Implementation approach determined</done>
</task>

<task type="auto">
  <name>Task 2: Implement device disable functionality</name>
  <files>src-tauri/src/vbcable/device_control.rs, src-tauri/src/vbcable/mod.rs</files>
  <action>
Create new module for device control:

**device_control.rs**:
```rust
//! Windows audio device enable/disable functionality

use windows::Win32::Devices::DeviceAndDriverInstallation::*;
use windows::Win32::Foundation::*;
use windows::core::PCWSTR;
use tracing::{info, warn, error};

const CABLE_16CH_NAME: &str = "CABLE In 16 Ch";

/// Find and disable the "CABLE In 16 Ch" device
/// Requires administrator rights
pub fn disable_cable_16ch() -> Result<(), String> {
    info!("Attempting to disable '{}'", CABLE_16CH_NAME);

    // Implementation using SetupAPI:
    // 1. Get device info set for audio devices
    // 2. Enumerate to find "CABLE In 16 Ch"
    // 3. Call SetupDiSetClassInstallParams with DICS_DISABLE
    // 4. Call SetupDiCallClassInstaller

    // ... implementation details ...

    Ok(())
}

/// Re-enable the "CABLE In 16 Ch" device if it was disabled
pub fn enable_cable_16ch() -> Result<(), String> {
    info!("Attempting to re-enable '{}'", CABLE_16CH_NAME);

    // Similar to disable but with DICS_ENABLE

    Ok(())
}

/// Check if "CABLE In 16 Ch" is currently disabled
pub fn is_cable_16ch_disabled() -> bool {
    // Check device status
    false
}
```

Add to Cargo.toml if needed:
```toml
[dependencies.windows]
features = [
    # ... existing ...
    "Win32_Devices_DeviceAndDriverInstallation",
]
```
  </action>
  <verify>cargo check compiles</verify>
  <done>Device disable functionality implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add Tauri commands for device control</name>
  <files>src-tauri/src/commands/vbcable.rs, src-tauri/src/lib.rs</files>
  <action>
Add commands to control the "CABLE In 16 Ch" device:

**commands/vbcable.rs**:
```rust
use crate::vbcable::{disable_cable_16ch, enable_cable_16ch, is_cable_16ch_disabled};

/// Disable the unused "CABLE In 16 Ch" device
/// Requires administrator rights - will trigger UAC if needed
#[tauri::command]
pub fn disable_cable_16ch_device() -> Result<(), String> {
    disable_cable_16ch()
}

/// Re-enable the "CABLE In 16 Ch" device
#[tauri::command]
pub fn enable_cable_16ch_device() -> Result<(), String> {
    enable_cable_16ch()
}

/// Check if "CABLE In 16 Ch" is disabled
#[tauri::command]
pub fn is_cable_16ch_device_disabled() -> bool {
    is_cable_16ch_disabled()
}
```

Register in lib.rs.
  </action>
  <verify>Commands registered, cargo check passes</verify>
  <done>Device control commands added</done>
</task>

<task type="auto">
  <name>Task 4: Auto-disable after VB-Cable installation</name>
  <files>src/components/settings/VbCableSettings.tsx</files>
  <action>
Add automatic disable of "CABLE In 16 Ch" after VB-Cable installation:

In handleInstall, after successful installation:
```typescript
// Step 8: Disable unused "CABLE In 16 Ch" device
setInstallStep("Deaktiviere nicht benötigte Geräte...");
try {
  await invoke("disable_cable_16ch_device");
  console.log("Disabled CABLE In 16 Ch device");
} catch (e) {
  // Non-critical - just log warning
  console.warn("Could not disable CABLE In 16 Ch:", e);
}
```

Also add UI toggle in VbCableSettings for manual control:
```tsx
{status?.status === "installed" && (
  <div className="mt-3 flex items-center justify-between text-sm">
    <span className="text-discord-text-muted">
      "CABLE In 16 Ch" Gerät
    </span>
    <button
      onClick={handleToggleCable16Ch}
      className="text-discord-primary hover:underline"
    >
      {isCable16ChDisabled ? "Aktivieren" : "Deaktivieren"}
    </button>
  </div>
)}
```
  </action>
  <verify>Device auto-disabled after install, toggle works</verify>
  <done>Auto-disable and manual toggle implemented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Automatic disabling of unused VB-Cable device</what-built>
  <how-to-verify>
    1. Uninstall VB-Cable if installed
    2. Run: yarn tauri dev
    3. Open Settings → Install VB-Cable
    4. After installation completes:
       - Open mmsys.cpl (Sound settings)
       - Check Playback devices
       - "CABLE In 16 Ch" should NOT appear (or be grayed out/disabled)
    5. In SonicDeck Settings:
       - Toggle should show current state
       - Can re-enable if needed
    6. Verify CABLE Input still works for sounds
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check --manifest-path src-tauri/Cargo.toml` succeeds
- [ ] `yarn typecheck` passes
- [ ] "CABLE In 16 Ch" auto-disabled after install
- [ ] Manual toggle works
- [ ] CABLE Input still functional
- [ ] Human verified
</verification>

<success_criteria>
- "CABLE In 16 Ch" automatically disabled after VB-Cable installation
- Users see cleaner device list
- Toggle available for manual control
- Core VB-Cable functionality (CABLE Input/Output) unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/02-vb-cable-integration/02-05-SUMMARY.md`
</output>

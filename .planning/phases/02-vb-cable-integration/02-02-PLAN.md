---
phase: 02-vb-cable-integration
plan: 02
type: execute
---

<objective>
Build VB-Cable installation flow and Settings UI integration.

Purpose: Enable users to install VB-Cable with maximum automation - download, silent install launch, and clear status feedback.
Output: VbCableSettings component in Settings, installer module with download + launch, visual installation flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vb-cable-integration/02-RESEARCH.md
@.planning/phases/02-vb-cable-integration/02-CONTEXT.md
@.planning/phases/02-vb-cable-integration/02-01-SUMMARY.md

**Relevant source files:**
@src/components/settings/Settings.tsx
@src/components/settings/AudioDeviceSettings.tsx
@src/types.ts
@src-tauri/src/vbcable/mod.rs
@src-tauri/src/commands/vbcable.rs

**User vision from CONTEXT.md:**
- Inline in Settings, kompakter Bereich mit Status + Action Button
- Maximum Automation - download + silent install, nur Windows Driver Dialog manuell
- Nach Install: VB-Cable automatisch als Secondary Output wählen
- Default Device automatisch wiederherstellen nach Installation

**Research findings to apply:**
- Silent install flags: `-i -h` (install, headless)
- Download URL: https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip
- Installer is in ZIP, needs extraction before running
- Windows WILL show driver approval dialog (cannot be bypassed)

**Don't hand-roll:**
- File download → use reqwest or tauri-plugin-http
- ZIP extraction → use zip crate
- Process execution → use std::process::Command
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add installer module with download and launch</name>
  <files>src-tauri/Cargo.toml, src-tauri/src/vbcable/mod.rs, src-tauri/src/vbcable/installer.rs</files>
  <action>
**Cargo.toml** - Add dependencies:
```toml
# VB-Cable installer dependencies
reqwest = { version = "0.12", features = ["blocking"] }
zip = "2.6"
```

**installer.rs** - Create installation flow:
```rust
//! VB-Cable installer download and launch

use std::fs::{self, File};
use std::io::{copy, Cursor};
use std::path::PathBuf;
use std::process::Command;
use tracing::{info, warn, error};

const VBCABLE_DOWNLOAD_URL: &str = "https://download.vb-audio.com/Download_CABLE/VBCABLE_Driver_Pack43.zip";
const VBCABLE_ZIP_NAME: &str = "VBCABLE_Driver_Pack43.zip";
const VBCABLE_INSTALLER_NAME: &str = "VBCABLE_Setup_x64.exe";

/// Download VB-Cable installer ZIP to temp directory
pub fn download_vbcable() -> Result<PathBuf, String> {
    let temp_dir = std::env::temp_dir().join("sonicdeck_vbcable");
    fs::create_dir_all(&temp_dir).map_err(|e| format!("Failed to create temp dir: {}", e))?;

    let zip_path = temp_dir.join(VBCABLE_ZIP_NAME);

    info!("Downloading VB-Cable from {}", VBCABLE_DOWNLOAD_URL);

    let response = reqwest::blocking::get(VBCABLE_DOWNLOAD_URL)
        .map_err(|e| format!("Download failed: {}", e))?;

    if !response.status().is_success() {
        return Err(format!("Download failed with status: {}", response.status()));
    }

    let bytes = response.bytes().map_err(|e| format!("Failed to read response: {}", e))?;
    let mut file = File::create(&zip_path).map_err(|e| format!("Failed to create file: {}", e))?;
    copy(&mut Cursor::new(bytes), &mut file).map_err(|e| format!("Failed to write file: {}", e))?;

    info!("Downloaded VB-Cable ZIP to {:?}", zip_path);
    Ok(zip_path)
}

/// Extract installer from ZIP
pub fn extract_installer(zip_path: &PathBuf) -> Result<PathBuf, String> {
    let temp_dir = zip_path.parent().ok_or("Invalid zip path")?;
    let installer_path = temp_dir.join(VBCABLE_INSTALLER_NAME);

    let file = File::open(zip_path).map_err(|e| format!("Failed to open ZIP: {}", e))?;
    let mut archive = zip::ZipArchive::new(file).map_err(|e| format!("Failed to read ZIP: {}", e))?;

    // Find the installer in the archive
    for i in 0..archive.len() {
        let mut file = archive.by_index(i).map_err(|e| format!("Failed to read ZIP entry: {}", e))?;
        if file.name().ends_with(VBCABLE_INSTALLER_NAME) {
            let mut outfile = File::create(&installer_path)
                .map_err(|e| format!("Failed to create installer file: {}", e))?;
            copy(&mut file, &mut outfile).map_err(|e| format!("Failed to extract installer: {}", e))?;

            info!("Extracted installer to {:?}", installer_path);
            return Ok(installer_path);
        }
    }

    Err("Installer not found in ZIP".to_string())
}

/// Launch VB-Cable installer with silent flags
/// Note: Windows will still show driver approval dialog
pub fn launch_installer(installer_path: &PathBuf) -> Result<(), String> {
    info!("Launching VB-Cable installer: {:?}", installer_path);

    // Run installer with -i (install) and -h (headless/silent) flags
    let status = Command::new(installer_path)
        .args(["-i", "-h"])
        .status()
        .map_err(|e| format!("Failed to launch installer: {}", e))?;

    if status.success() {
        info!("VB-Cable installer completed successfully");
        Ok(())
    } else {
        let code = status.code().unwrap_or(-1);
        warn!("VB-Cable installer exited with code: {}", code);
        // Don't treat non-zero as error - user may have cancelled driver dialog
        Ok(())
    }
}

/// Full installation flow: download, extract, launch
pub fn install_vbcable() -> Result<(), String> {
    let zip_path = download_vbcable()?;
    let installer_path = extract_installer(&zip_path)?;
    launch_installer(&installer_path)?;

    // Cleanup ZIP (keep installer in case user needs to retry)
    let _ = fs::remove_file(&zip_path);

    Ok(())
}

/// Cleanup temp files
pub fn cleanup_temp_files() {
    let temp_dir = std::env::temp_dir().join("sonicdeck_vbcable");
    if temp_dir.exists() {
        let _ = fs::remove_dir_all(&temp_dir);
        info!("Cleaned up VB-Cable temp files");
    }
}
```

**mod.rs** - Add export:
```rust
mod installer;
pub use installer::{install_vbcable, cleanup_temp_files};
```
  </action>
  <verify>cargo check --manifest-path src-tauri/Cargo.toml compiles without errors</verify>
  <done>Installer module created with download, extract, and launch functions</done>
</task>

<task type="auto">
  <name>Task 2: Add Tauri commands for installation flow</name>
  <files>src-tauri/src/commands/vbcable.rs, src-tauri/src/lib.rs, src/types.ts</files>
  <action>
**commands/vbcable.rs** - Add installation commands:
```rust
use crate::vbcable::{install_vbcable, cleanup_temp_files, DefaultDeviceManager};

/// Start VB-Cable installation (download + silent install)
/// Frontend should call save_default_audio_device BEFORE this
#[tauri::command]
pub async fn start_vb_cable_install() -> Result<(), String> {
    // Run blocking install in thread to not block async runtime
    tokio::task::spawn_blocking(|| {
        install_vbcable()
    })
    .await
    .map_err(|e| format!("Install task failed: {}", e))?
}

/// Cleanup temporary installation files
#[tauri::command]
pub fn cleanup_vb_cable_install() {
    cleanup_temp_files();
}

/// Open VB-Audio website (fallback if automated install fails)
#[tauri::command]
pub fn open_vb_audio_website() -> Result<(), String> {
    open::that("https://vb-audio.com/Cable/")
        .map_err(|e| format!("Failed to open browser: {}", e))
}
```

Note: Need to add `open` crate to Cargo.toml:
```toml
open = "5.3"
```

Also need `tokio` features for spawn_blocking - check if tauri already provides async runtime.
If not using tokio, use `std::thread::spawn` with channels instead.

**lib.rs** - Register new commands:
Add `start_vb_cable_install`, `cleanup_vb_cable_install`, `open_vb_audio_website` to invoke_handler.

**types.ts** - Add TypeScript types:
```typescript
export type VbCableStatus =
  | { type: "Installed"; info: VbCableInfo }
  | { type: "NotInstalled" };

export interface VbCableInfo {
  output_device: string;
  input_device: string;
}
```
  </action>
  <verify>cargo check compiles, yarn typecheck passes</verify>
  <done>Installation commands registered, TypeScript types added</done>
</task>

<task type="auto">
  <name>Task 3: Create VbCableSettings component</name>
  <files>src/components/settings/VbCableSettings.tsx, src/components/settings/Settings.tsx</files>
  <action>
**VbCableSettings.tsx** - Create component:
```tsx
import { useState, useEffect } from "react";
import { invoke } from "@tauri-apps/api/core";
import { VbCableStatus } from "../../types";

interface VbCableSettingsProps {
  onDeviceChange?: () => void; // Callback to refresh device list after install
}

export default function VbCableSettings({ onDeviceChange }: VbCableSettingsProps) {
  const [status, setStatus] = useState<VbCableStatus | null>(null);
  const [isInstalling, setIsInstalling] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [savedDeviceId, setSavedDeviceId] = useState<string | null>(null);

  // Check VB-Cable status on mount
  useEffect(() => {
    checkStatus();
  }, []);

  const checkStatus = async () => {
    try {
      const result = await invoke<VbCableStatus>("check_vb_cable_status");
      setStatus(result);
      setError(null);
    } catch (e) {
      setError(`Failed to check status: ${e}`);
    }
  };

  const handleInstall = async () => {
    setIsInstalling(true);
    setError(null);

    try {
      // Save current default device before install
      const deviceId = await invoke<string>("save_default_audio_device");
      setSavedDeviceId(deviceId);

      // Start installation
      await invoke("start_vb_cable_install");

      // Wait a bit for Windows to register the device
      await new Promise((resolve) => setTimeout(resolve, 2000));

      // Check if VB-Cable is now installed
      await checkStatus();

      // Restore default audio device
      if (deviceId) {
        await invoke("restore_default_audio_device", { deviceId });
      }

      // Notify parent to refresh device list
      onDeviceChange?.();

      // Cleanup temp files
      await invoke("cleanup_vb_cable_install");
    } catch (e) {
      setError(`Installation failed: ${e}`);
    } finally {
      setIsInstalling(false);
    }
  };

  const handleOpenWebsite = async () => {
    try {
      await invoke("open_vb_audio_website");
    } catch (e) {
      setError(`Failed to open website: ${e}`);
    }
  };

  return (
    <div className="bg-discord-dark rounded-lg p-6">
      <h2 className="text-xl font-semibold text-discord-text mb-4">
        VB-Cable Integration
      </h2>

      {status?.type === "Installed" ? (
        <div className="space-y-3">
          <div className="flex items-center gap-2 text-discord-success">
            <span className="text-lg">✓</span>
            <span>VB-Cable is installed</span>
          </div>
          <p className="text-sm text-discord-text-muted">
            Device: {status.info.output_device}
          </p>
        </div>
      ) : (
        <div className="space-y-4">
          <p className="text-sm text-discord-text-muted">
            VB-Cable is required for dual-output routing to Discord.
          </p>

          <div className="flex gap-3">
            <button
              onClick={handleInstall}
              disabled={isInstalling}
              className="px-4 py-2 bg-discord-primary hover:bg-discord-primary-hover
                       disabled:bg-gray-600 disabled:cursor-not-allowed rounded
                       text-white font-medium transition-colors"
            >
              {isInstalling ? "Installing..." : "Install VB-Cable"}
            </button>

            <button
              onClick={handleOpenWebsite}
              className="px-4 py-2 bg-discord-darker hover:bg-discord-dark
                       rounded text-discord-text-muted transition-colors"
            >
              Manual Download
            </button>
          </div>

          {isInstalling && (
            <p className="text-sm text-discord-text-muted">
              ⏳ Downloading and installing... Windows may ask you to approve the driver.
            </p>
          )}
        </div>
      )}

      {error && (
        <div className="mt-4 p-3 bg-discord-danger/20 border border-discord-danger rounded">
          <p className="text-sm text-discord-danger">{error}</p>
        </div>
      )}
    </div>
  );
}
```

**Settings.tsx** - Add VbCableSettings:
Import and add the component in the settings layout, between the header and AudioDeviceSettings:
```tsx
import VbCableSettings from "./VbCableSettings";

// In the render, add before AudioDeviceSettings:
<VbCableSettings onDeviceChange={handleRefresh} />
```

Pass `handleRefresh` (or create one) to refresh device list after VB-Cable install.
  </action>
  <verify>yarn typecheck passes, yarn lint passes, yarn tauri dev shows VbCableSettings in Settings</verify>
  <done>VbCableSettings component created and integrated in Settings</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>VB-Cable installation flow with Settings UI</what-built>
  <how-to-verify>
    1. Run: yarn tauri dev
    2. Open Settings (gear icon or hotkey)
    3. Look for "VB-Cable Integration" section
    4. If VB-Cable NOT installed:
       - Click "Install VB-Cable" button
       - Observe download progress (terminal logs)
       - Windows will show driver approval dialog - approve it
       - After approval, status should change to "Installed"
       - Device list should show VB-Cable
    5. If VB-Cable already installed:
       - Status should show "✓ VB-Cable is installed"
       - Device name should be displayed
    6. Test "Manual Download" button opens VB-Audio website
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check --manifest-path src-tauri/Cargo.toml` succeeds
- [ ] `yarn typecheck` passes
- [ ] `yarn lint` passes (or warnings only)
- [ ] `yarn tauri dev` starts without errors
- [ ] VbCableSettings component renders in Settings
- [ ] Install button works (download + installer launch)
- [ ] Status correctly shows Installed/NotInstalled
</verification>

<success_criteria>
- All tasks completed
- VB-Cable can be installed from within SonicDeck
- UI shows correct installation status
- Human verified the installation flow works
</success_criteria>

<output>
After completion, create `.planning/phases/02-vb-cable-integration/02-02-SUMMARY.md`
</output>
